## 4. CRITICAL: Effects / Redux State Management Bugs

**Automation Status**: PARTIALLY AUTOMATED (4.5, 4.6, dropdown closure)

### Prerequisites: Test Data Setup for State Management Tests

Use the complete set of incidents (A-J). These tests focus on how the UI responds to state changes rather than specific data values.

### 4.1 Basic Element Rendering
**Automation Status**: AUTOMATED
- Covered by `01.incidents.cy.ts` (tests 2, 3) and `04.reg_redux_effects.cy.ts` (test 3)
- Tests days filter changes and severity filter updates
- Verifies chart updates immediately without page reload

- [x] **Incidents Refresh on Days Change**: AUTOMATED in `01.incidents.cy.ts` test 2
  - Start with "Last 7 days" (showing all 10 incidents A-J)
  - Change to "Last 1 day" (should show only recent incidents)
  - Verify incidents chart updates, loading spinner shows, new data displayed
  
- [x] **Filtered Data Updates on Filter Change**: AUTOMATED in `01.incidents.cy.ts` test 3 and `04.reg_redux_effects.cy.ts` test 3
  - Apply "Critical" filter → verify only D, E, H shown
  - Add "Warning" filter → verify B, F, G, I, J also appear
  - Verify chart updates immediately (no page reload)

### 4.2 Selected Incident Does Not Survive State Changes
**BUG**: Selected incident was being lost when changing filters or toggling graphs.  
**Automation Status**: PARTIALLY AUTOMATED (filter changes covered, graph toggle not covered)
- Covered by `04.reg_redux_effects.cy.ts` test 3
- Tests incident ID filter persistence when non-matching severity filter applied
- Graph toggle test not automated

- [x] **Selection Survives Severity Filter**: AUTOMATED in `04.reg_redux_effects.cy.ts` test 3
  - Select Incident D (has Info, Warning, Critical in history)
  - Apply "Warning" filter (D matches because it had Warning)
  - Verify: Incident D still selected, URL has `?groupId=D`, alerts still shown
  
- [x] **Selection Lost When Filtered Out (but ID filter persists)**: AUTOMATED in `04.reg_redux_effects.cy.ts` test 3
  - Select Incident A (Info only)
  - Apply "Critical" filter (A doesn't match)
  - Verify: Incident A disappears, but Incident ID filter chip remains, appropriate state
  
- [ ] **Selection Survives Graph Toggle**: NOT AUTOMATED
  - Select Incident H
  - Click "Hide graph"
  - Verify: URL still has `?groupId=H`, table shows H's alert
  - Click "Show graph" → verify chart renders correctly

### 4.3 Stale Alerts Displayed on Incident Reselection
**BUG**: When switching between incidents, stale alerts from previous incident shown briefly.  
**Automation Status**: INDIRECTLY COVERED by `01.incidents.cy.ts` (test 5: Traverse Incident Table)
- The `findIncidentWithAlert` method would fail if stale alerts from previous selections are displayed
- Not explicitly tested with dedicated assertions, but functionality breaks if bug exists

- [ ] **Incident Switching**: 
  - Select Incident D (with 3 alerts: Info, Warning, Critical)
  - Deselect Incident D
  - Immediately select Incident E (3 different component alerts)
  - Verify: NO brief flash of D's alerts; loading state shown immediately
  - Verify: Only E's alerts displayed after fetch completes
  
- [ ] **Deselect Incident**: 
  - Select Incident F
  - Click on Incident F again to deselect
  - Verify: Alerts chart shows "select an incident" empty state
  - Verify: No stale alerts remain

### 4.4 Incident Dropdown Staying Open After Page Refresh
**BUG**: Dropdowns remained open after page refresh (Incidents Display / not F5).  
**Automation Status**: AUTOMATED in `04.reg_redux_effects.cy.ts` (Test 2: Dropdown closure on deselection)

- [ ] **Dropdown State After Refresh**: 
  - Select a particular Incident
  - ~~Toggle filters that cause deselection of the incident and page reload~~
  NOTE: This won't happen, as the page will not be reloaded in new update
  - Verify: Dropdown is closed after reload
  - Verify: Dropdown does not jump to 0,0 coordinates
  - Verify: Filter state restored from URL but dropdown collapsed

  ### 4.5 Dropdown Staying open after deselection
  **BUG**: Deselection of incident causes reposition of the dropdown  
  **Automation Status**: AUTOMATED in `04.reg_redux_effects.cy.ts` (Test 2: Dropdown closure on deselection)
  - Select a particular incident
  - Open the left dropdown menu (Severity, State, ID)
  - Deselect the incident by clicking on the bar, the site data should reload
  - Verify: The dropdown should not reposition to 0.0 and should be closed
  - Verify: Do the same also with the right toolbar.
  


- [ ] **Dropdowns Auto-Close After Selection**: 
  - Open "Days" dropdown → select "3 days" → verify closes
  - Open "Incident ID" filter → select an incident → verify closes

### 4.5 Adding filter when incident selected does not remove the incident filter
**BUG:** When incident-id was filtered and additional filter (severity) applied, then if the filter was not matching the selected issue, the id filter was removed.  
**Automation Status**: AUTOMATED in `04.reg_redux_effects.cy.ts` (Test 3: Filter state preservation)
- [ ] Select a "critical" incident by id
- [ ] Apply waring filter.
- [ ] Verify incident is filtered out
- [ ] Verify the filters "warning", and "incident id" are applied.  

### 4.6 Incidents Not Loaded Initially
**BUG**: Old Redux state was being used for effects fired at the beginning of page load. When the page loaded, only several issues were displayed.  
**Automation Status**: AUTOMATED in `04.reg_redux_effects.cy.ts` (Test 1: Fresh load verification)

**NOTE:** Hard to replicate, requires fresh browser instance

### 4.7 Cached end time for prometheus query 
**BUG**: End Time parameter for the prometheus query request uses the time of the initial load of the page instead of the current time, which causes firing alerts to be marked as resolved.  
**Automation Status**: NOT AUTOMATED (requires live firing alerts)  
**NOTE**: The issue is conceptually very similiar to 3.3, but is caused by the redux state caching, so it belongs to this section. 
- **WARNING Not possible to test on Injected Data, requires continously firing alert, mocked (firing) data might be applicable though.**
  - Trigger a real firing alert (Pod CrashLooping...)
  - Verify that the alert is firing
  - Wait for 10 minutes without refreshing incidents
  - Refresh the days filter.
  - Verify that the end time in the query to prometheus is updated to the current time value.
  - Verify


