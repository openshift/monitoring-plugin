## 3. CRITICAL: Data Loading – API Call Bugs

**Automation Status**: PARTIALLY AUTOMATED (Sections 3.1, 3.2, and 3.5)

### Prerequisites: Test Data Setup for Data Loading Tests

**CSV Format** - These alerts test resolution, short duration, and silence logic (creates incidents F, G, I, J):

```csv
start,end,alertname,namespace,severity,silenced,labels
1140,1260,AlertF_KubePodCrashLooping,openshift-monitoring,warning,false,{"component": "monitoring"}
1200,1380,AlertF_HighMemoryUsage,openshift-monitoring,critical,false,{"component": "monitoring"}
1440,1500,AlertG_APIServerLatency,openshift-kube-apiserver,warning,false,{"component": "kube-apiserver"}
1800,1980,AlertI_KubePodNotReady,openshift-operators,warning,true,{"component": "operators"}
2040,2220,AlertJ_KubePodNotReady,openshift-storage,warning,false,{"component": "storage"}
```

**Silence Matching Logic**:
- Silence determined by `silenced` field in CSV (becomes label in `cluster_health_components_map` metric)
- Incidents I and J have same `alertname` but different `namespace` and different `silenced` values
- Tests that silence matching uses: `alertname` + `namespace` + `severity` (NOT just alert name)

**Quick Reference** (Alerts & Silences):
| Alert | alertname | namespace | severity | Time Range | Expected State | silenced | Use For Testing |
|-------|-----------|-----------|----------|------------|----------------|----------|-----------------|
| F1 | AlertF_KubePodCrashLooping | openshift-monitoring | warning | 1140-1260 | Resolved | false | Time-based resolution |
| F2 | AlertF_HighMemoryUsage | openshift-monitoring | critical | 1200-1380 | Resolved | false | Time-based resolution |
| G | AlertG_APIServerLatency | openshift-kube-apiserver | warning | 1440-1500 | Resolved | false | Short duration (1 hr) |
| I | AlertI_KubePodNotReady | openshift-operators | warning | 1800-1980 | Resolved | **true** | Silence matching |
| J | AlertJ_KubePodNotReady | openshift-storage | warning | 2040-2220 | Resolved | **false** | Different namespace = not silenced |


### 3.1 Short Incidents Not Visible
**BUG**: Incidents with duration < 5 minutes weren't showing up.  
**Automation Status**: AUTOMATED in `02.reg_ui_charts_comprehensive.cy.ts` (Section 3.1)
- Uses fixture: `incident-scenarios/12-charts-ui-comprehensive.yaml` (includes very short duration incidents)
- Tests: 5-minute, 9-minute, and recently resolved (2 min ago) incidents
- Verifies: Bar visibility, dimensions, transparency, selectability, and alert loading

- [x] **Short Incident C**: Check `api-server` incident (0 min duration, single point) - AUTOMATED
  - Verify appears in incidents chart (has visible bar despite 0 duration)
  - Select it and verify alert loads
  
- [x] **Short Incident G**: Check `kube-apiserver` incident (60 min duration) - AUTOMATED
  - Verify appears in incidents chart with visible bar
  - Select it and verify AlertG_APIServerLatency appears
  - Verify no minimum duration threshold filters it out

### 3.2 Silences Not Applied Correctly
**BUG**: Silences were being matched by name only, not by name + namespace + severity.  
**Automation Status**: AUTOMATED in `03.reg_api_calls.cy.ts`
- Uses fixture: `incident-scenarios/9-silenced-alerts-mixed-scenario.yaml`
- Verifies: Opacity (0.3 for silenced, 1.0 for non-silenced)
- Verifies: Tooltip "(silenced)" indicator
- Tests: Same alert name with different namespaces

- [ ] **Incident I IS Silenced**: Check `AlertI_KubePodNotReady` in `openshift-operators`
  - Silence matches: name=`KubePodNotReady` + namespace=`openshift-operators` + severity=`warning`
  - Expected: Alert marked as `silenced = true`
  - Verify alert bar has opacity: 0.3 (reduced)
  - Verify tooltip shows: "AlertI_KubePodNotReady (silenced)"
  
- [ ] **Incident J NOT Silenced**: Check `AlertJ_KubePodNotReady` in `openshift-storage`
  - Same alert name as Incident I, but DIFFERENT namespace
  - Silence does NOT match (namespace mismatch)
  - Expected: Alert marked as `silenced = false`
  - Verify alert bar has opacity: 1.0 (full)
  - Verify tooltip shows: "AlertJ_KubePodNotReady" (no silenced suffix)
  
- [ ] **Silence Matching Logic**: Verify implementation
  - Check that matching uses: `alertname` + `namespace` + `severity`
  - NOT just `alertname` alone
  - Silence source: `cluster_health_components_map` metric (NOT Alertmanager API)

  ### 3.3 Alerts Marked as Resolved After Time
**BUG**: Alerts not being marked as resolved when they should be.  
**Automation Status**: NOT AUTOMATED (requires live firing alerts)
- **WARNING Not possible to test on Injected Data, requires continously firing alert**
  - Trigger a real firing alert (Pod CrashLooping...)
  - Verify that the alert is firing
  - Wait for 10 minutes without refreshing incidents
  - Toggle the days filter to retrigger the alert queries
  - Verify it is not marked as resolved
  - Verify the latest query end time param is within the last 5 minutes


  ### 3.4 Data Integrity
  **NEW, NOT AUTOMATED, TODO COO 1.4**
- [ ] Incident grouping by `group_id` works correctly
- [ ] Values deduplicated across multiple time range queries
- [ ] Component lists combined for same group_id
- [ ] Watchdog alerts filtered out

### 3.5 Permission Denied Handling
**BUG**: Page should gracefully handle 403 Forbidden responses from API endpoints.  
**Automation Status**: AUTOMATED in `03.reg_api_calls.cy.ts`
- Uses mock: `cy.mockPermissionDenied({ rules: true, silences: true, prometheus: true })`
- Manual replication: Apply resources from [`docs/incident_detection/resources/`](../resources/)

- [ ] **403 Forbidden Response**: Create user with limited permissions (testuser/password123)
  - Apply: `htpasswd-secret.yaml`, `oauth-htpasswd.yaml`, `limited-permissions-user.yaml`
  - Login as testuser, navigate to Observe → Incidents
  - Expected: `<EmptyState data-test="access-denied">` with "Restricted access" text

