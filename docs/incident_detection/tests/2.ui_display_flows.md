## 2. CRITICAL: Charts – UI Bugs

**Automation Status**: AUTOMATED in `02.reg_ui_charts_comprehensive.cy.ts` apart from 2.3.1 and 2.4
- Uses fixture: `incident-scenarios/12-charts-ui-comprehensive.yaml`
- Covers: Tooltip positioning, bar sorting & visibility, date/time display
- Verifies: Incidents chart, alerts chart, multi-component tooltips, long alert names

### Prerequisites: Test Data Setup for Chart Tests

**CSV Format** - Add these to the incidents from Section 1 (these create incidents C, D, E):

```csv
start,end,alertname,namespace,severity,silenced,labels
420,420,AlertC_ShortDuration,openshift-apiserver,warning,false,{"component": "api-server"}
480,780,AlertD_Info,openshift-monitoring,info,false,{"component": "monitoring"}
540,780,AlertD_Warning,openshift-monitoring,warning,false,{"component": "monitoring"}
600,780,AlertD_Critical,openshift-monitoring,critical,false,{"component": "monitoring"}
840,1080,AlertE_Etcd,openshift-etcd,critical,false,{"component": "etcd"}
840,1080,AlertE_KubeAPI,openshift-kube-apiserver,critical,false,{"component": "kube-apiserver"}
840,1080,AlertE_Controller_Very_Very_Very_Very_Long_Name_Alert,openshift-kube-controller,critical,false,{"component": "kube-controller"}
```

**Quick Reference** (Charts Test Data):
| Incident | Components | Duration | Severity | Time Range | Use For Testing |
|----------|------------|----------|----------|------------|-----------------|
| C | api-server | 0 min | Warning | 420 | Short duration visibility |
| D | monitoring | 5 hrs | Multi-severity (Info→Warning→Critical) | 480-780 | Multi-severity segments |
| E | etcd, kube-apiserver, kube-controller | 4 hrs | Critical | 840-1080 | Multi-component tooltip, long names |

### 2.1 Tooltip Positioning Issues
**BUG**: Tooltips were overlapping bars or going off-screen.  
**Automation Status**: AUTOMATED

- [ ] **Tooltip Positioning - Incidents Chart**: 
  - Hover over Incident A (oldest, at bottom)
  - Hover over Incident H (one of newest, near top)
  - Hover over Incident D (middle position)
  - Verify tooltip appears directly above/on each bar without overlap
  
- [ ] **Tooltip Content - Multi-Component**: Hover over Incident E
  - Verify shows: "Component(s): etcd, kube-apiserver, kube-controller"
  - Verify comma-separated list format
  - Test with long alert name (Controller_Very_Very_Very_Very_Long_Name_Alert)
  
- [ ] **Tooltip Content - Firing vs Resolved**: 
  - Hover over Incident D (firing): End should show "---"
  - Hover over Incident A (resolved): End should show actual end time

- [ ] **Tooltip Positioning - Alerts Chart**
  - Select Incident E (multi-component)
  - Hover over all 3 alerts in the incident
  - Verify Tooltip appears directly above each bar
  - Verify alert name length does not influence the behaviour (test long controller name)

### 2.2 Bar Sorting & Visibility Issues
**BUGS**: Bars not sorted by start date, filtered bars not leaving space, short alerts not visible.  
**Automation Status**: AUTOMATED

- [ ] **Bar Sorting by Start Date**: Check incidents chart Y-axis order
  - Expected order (oldest at bottom):
    1. Incident A (0-180) - bottom
    2. Incident B (240-360)
    3. Incident C (420)
    4. Incident D (480-780)
    5. Incident E (840-1080)
    6. Incident F (1140-1380)
    7. Incident G (1440-1500)
    8. Incident H (1560-1740)
    9. Incident I (1800-1980)
    10. Incident J (2040-2220) - top
  - Verify this order maintained after applying filters
  
- [ ] **Filtered Bars Leave Empty Space**: Apply "Critical" filter
  - Expected visible: D, E, H (Critical incidents)
  - Expected hidden but space preserved: A, B, C, F, G, I, J
  - Verify gaps appear where non-Critical incidents would be
  - Verify Y-axis still shows all 10 positions
  
- [ ] **Short Duration Incidents Visible**: Check Incident C (single point at 420)
  - Verify bar IS visible despite 0-minute duration
  - Hover to confirm tooltip shows Incident C
  - Verify bar has minimum visible width

### 2.3 Date/Time Display Issues
**BUGS**: Start/End times not displaying correctly, date format not respecting language.  
**Automation Status**: AUTOMATED

- [ ] **Start/End Times Correct**: Check specific incidents
  - Incident D (firing): Start = T-480min, End = "---"
  - Incident A (resolved): Start = T-0min, End = T-180min (both shown)
  - Incident C (short, resolved): Start = T-420min, End = T-420min
  - Verify tooltip shows these times correctly
  
- [ ] **Multi-Severity Segments**: Check Incident D (Info→Warning→Critical)
  - Verify each severity segment shows correct time range:
    - Info segment: T-480min to T-540min
    - Warning segment: T-540min to T-600min
    - Critical segment: T-600min to "---"
  
- [ ] **Date Format Respects Language**: 
  - Set browser/app language to English
  - Check Incident A tooltip: should show "Jan 15, 2025, 3:45 PM" format
  - Switch to Chinese (if available) and verify format changes
  - Verify `dateTimeFormatter(i18n.language)` respects setting

### 2.3.1 (Not Automated)
- [ ] **Date Format Changed Immediately** (xfail):
  - Change the app language to Spanish
  - Check the "last updated date" field
  - Verify that the format changes without the need to reload the page

### 2.3.2 Incident Bar Trimming on Time Filter Change
**BUG**: When "Last N Days" is shorter than an incident's duration, the bar should be visually trimmed to show only the portion within the selected time window.  
**Automation Status**: NOT AUTOMATED

**Background**:
- Incorrect behavior: Changing time filter "squashes" the X-axis to the right while still showing the full incident bar
- Correct behavior: Incident bar is trimmed/clipped to only display the portion that falls within the selected time range

- [ ] **Bar Trimming - Long Incident with Short Filter**: Create an incident spanning 15 days
  - With "Last 15 days": Full incident bar visible with correct proportional width
  - Set time filter to "Last 7 days"
  - Verify the incident bar is trimmed to show only the 7-day portion (not the full 15-day bar)
  - Verify the X-axis scale matches the 7-day window (not squashed to the right)
  - Verify the bar starts at the left edge of the chart (since incident started before the 7-day window)

- [ ] **Tooltip Accuracy After Trimming**: Hover over a trimmed incident bar
  - Verify tooltip shows the actual absolute Start date (which may be before the visible window)
  - Verify tooltip shows correct End date
  - Verify the displayed duration reflects the full incident, not just the visible portion

### 2.3.3 Mixed Severity Interval Boundary Times
**Automation Status**: NOT AUTOMATED

This section covers two related time display bugs in multi-severity incident tooltips.

#### Issue 1: Boundary End Times Not Rounded (OU-1205)
**BUG**: Consecutive interval end times within the same incident bar are not 5-minute rounded in tooltips.

**Background**:
- The interval calculation logic in `utils.ts` uses 1-second offsets to prevent overlapping intervals
- Example: If timestamps are at 100, 200, 300 seconds, intervals are calculated as:
  - Interval 1: [100, 199, 'critical']
  - Interval 2: [200, 299, 'warning']
- This results in end times like "23:29:59" instead of the expected rounded "23:30"
- The fix should round the displayed tooltip text, not change the interval calculation logic

- [ ] **End Times Should Be 5-Minute Rounded**: Use AlertC from test data (multi-severity incident)
  - Hover over each severity segment within the incident bar
  - Verify End time in tooltip shows rounded value (e.g., "23:30") not unrounded (e.g., "23:29:59")
  - Verify all interval boundaries display at 5-minute precision in tooltips

#### Issue 2: Start Times 5 Minutes Off (OU-1221)
**BUG**: Multi-severity incident bar tooltip start times are 5 minutes off from the values shown in alert tooltips and alerts table.

**Background**:
- When hovering over a severity segment in an incident bar, the Start time shown differs from:
  - The Start time shown in the corresponding alert tooltip
  - The Start time shown in the alerts details table
- This creates user confusion as the same data point shows different times in different UI elements

- [ ] **Start Times Match Alert Tooltip**: Use AlertC from test data
  - Click incident to open alerts chart
  - Hover over an alert bar: Note the Start time in alert tooltip
  - Hover over the corresponding severity segment in the incident bar
  - Verify incident tooltip Start time matches alert tooltip Start time exactly

- [ ] **Start Times Match Alerts Table**: 
  - With incident selected, check alerts table Start column
  - Hover over the corresponding severity segment in incident bar
  - Verify incident tooltip Start time matches alerts table Start time exactly

- [ ] **Consecutive Interval Boundaries Match**: Check multi-severity incident
  - Hover over first severity segment: Note the End time
  - Hover over next severity segment: Note the Start time
  - Verify End time of previous segment matches Start time of next segment (no 5-minute gap)
  - Example failure: Info ends at "10:15" but Warning starts at "10:20"
  - Expected: Info ends at "10:15" and Warning starts at "10:15"

### 2.4 Silences labels (Not Automated)
- Verify that information about silences is contained in the alert name 
  as `NetworkLatencyHigh (silenced)` instead of the additional `silenced=true`
  field


